{% extends "base_fr.html" %}

{% block title %}{{ project.name }} - Calendrier{% endblock %}
{% block header %}{{ project.name }} - Calendrier{% endblock %}
{% block create_btn %}Nouvelle Tâche{% endblock %}

{% block content %}
<div class="bg-white/70 dark:bg-slate-800/60 backdrop-blur-xl rounded-2xl p-6 shadow-lg border border-white/20 dark:border-slate-700/50 flex flex-col h-[calc(100vh-140px)]">
    
    <div class="flex flex-col sm:flex-row items-center justify-between gap-4 mb-6">
        
        <div class="flex items-center gap-4 bg-white/50 dark:bg-slate-700/30 p-1.5 rounded-xl border border-white/20 dark:border-slate-600/50 shadow-sm">
            <button onclick="changeMonth(-1)" class="p-2 w-10 h-10 flex items-center justify-center hover:bg-white dark:hover:bg-slate-600 rounded-lg transition-all text-slate-600 dark:text-slate-300">
                <i class="fa-solid fa-chevron-left"></i>
            </button>
            
            <h2 class="text-xl font-bold text-slate-800 dark:text-white capitalize min-w-[200px] text-center">
                {{ current_month }} <span class="text-brand-600 font-light">{{ current_year }}</span>
            </h2>
            
            <button onclick="changeMonth(1)" class="p-2 w-10 h-10 flex items-center justify-center hover:bg-white dark:hover:bg-slate-600 rounded-lg transition-all text-slate-600 dark:text-slate-300">
                <i class="fa-solid fa-chevron-right"></i>
            </button>
        </div>
        
        <div class="flex items-center gap-6">
             <div class="hidden md:flex items-center gap-3 text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider">
                <span class="flex items-center gap-1.5"><span class="w-2.5 h-2.5 rounded-full bg-indigo-500 shadow-[0_0_8px_rgba(99,102,241,0.6)]"></span> À Faire</span>
                <span class="flex items-center gap-1.5"><span class="w-2.5 h-2.5 rounded-full bg-amber-500 shadow-[0_0_8px_rgba(245,158,11,0.6)]"></span> En Cours</span>
                <span class="flex items-center gap-1.5"><span class="w-2.5 h-2.5 rounded-full bg-emerald-500 shadow-[0_0_8px_rgba(16,185,129,0.6)]"></span> Terminé</span>
            </div>
            <button onclick="goToToday()" class="px-4 py-2 bg-brand-50 dark:bg-brand-900/20 text-brand-600 dark:text-brand-400 text-sm font-bold rounded-lg border border-brand-100 dark:border-brand-800 hover:bg-brand-100 dark:hover:bg-brand-900/40 transition-colors shadow-sm">
                Aujourd'hui
            </button>
        </div>
    </div>

    <div class="grid grid-cols-7 mb-2">
        {% for day in ['Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam', 'Dim'] %}
        <div class="text-center text-xs font-extrabold text-slate-400 uppercase tracking-widest py-2">
            {{ day }}
        </div>
        {% endfor %}
    </div>

    <div class="grid grid-cols-7 grid-rows-6 gap-px bg-slate-200 dark:bg-slate-700 border border-slate-200 dark:border-slate-700 rounded-xl overflow-hidden flex-1 shadow-inner">
        {% for day in calendar_days %}
        <div class="relative group p-2 min-h-[80px] transition-colors flex flex-col gap-1
            {% if day.is_current_month %}
                bg-white dark:bg-slate-800 hover:bg-slate-50 dark:hover:bg-slate-700/80
            {% else %}
                bg-slate-50/80 dark:bg-slate-900/50 text-slate-400
            {% endif %}">
            
            <div class="flex justify-between items-start">
                <span class="text-sm font-bold w-7 h-7 flex items-center justify-center rounded-full transition-all
                    {% if day.is_today %}
                        bg-brand-600 text-white shadow-lg shadow-brand-500/40 scale-110
                    {% else %}
                        text-slate-600 dark:text-slate-400 group-hover:text-brand-600
                    {% endif %}">
                    {{ day.day }}
                </span>
                
                {% if day.is_current_month %}
                <button onclick="openNewTaskModalWithDate('{{ day.date.strftime('%Y-%m-%d') }}')" class="opacity-0 group-hover:opacity-100 text-slate-400 hover:text-brand-600 transition-opacity p-1">
                    <i class="fa-solid fa-plus-circle"></i>
                </button>
                {% endif %}
            </div>

            <div class="flex-1 flex flex-col gap-1 overflow-hidden mt-1">
                {% for task in day.tasks %}
                <div onclick="showTaskDetails({{ task | tojson | safe }})"
                     class="cursor-pointer px-2 py-1 rounded-md text-[10px] font-bold truncate border-l-[3px] shadow-sm hover:scale-[1.02] transition-transform
                    {% if task.status == 'todo' %}
                        bg-indigo-50 dark:bg-indigo-900/20 text-indigo-700 dark:text-indigo-300 border-indigo-500
                    {% elif task.status == 'in_progress' %}
                        bg-amber-50 dark:bg-amber-900/20 text-amber-700 dark:text-amber-300 border-amber-500
                    {% else %}
                        bg-emerald-50 dark:bg-emerald-900/20 text-emerald-700 dark:text-emerald-300 border-emerald-500 line-through opacity-70
                    {% endif %}">
                    {{ task.title }}
                </div>
                {% endfor %}
                
                {% if day.extra_tasks > 0 %}
                <div class="text-[10px] text-slate-400 font-medium pl-1 hover:text-slate-600 cursor-pointer">
                    + {{ day.extra_tasks }} autres...
                </div>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<div id="taskModal" class="hidden fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-50 flex items-center justify-center transition-opacity duration-300">
    <div class="bg-white dark:bg-slate-800 rounded-2xl w-full max-w-md mx-4 shadow-2xl border border-slate-200 dark:border-slate-700 transform transition-all scale-100 p-0 overflow-hidden">
        <div id="taskModalContent"></div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        switchToProjectNav('{{ project.id }}', '{{ project.name }}');
        document.getElementById('calendarTab').classList.add('bg-brand-50', 'dark:bg-brand-900/20', 'text-brand-600', 'dark:text-brand-400');
    });

    // --- Navigation Logic ---
    function changeMonth(offset) {
        let currentMonth = {{ current_month_index }};
        let currentYear = {{ current_year }};
        
        let newMonth = currentMonth + offset;
        let newYear = currentYear;
        
        if (newMonth > 12) {
            newMonth = 1;
            newYear++;
        } else if (newMonth < 1) {
            newMonth = 12;
            newYear--;
        }
        window.location.href = `?year=${newYear}&month=${newMonth}`;
    }

    function goToToday() {
        const now = new Date();
        window.location.href = `?year=${now.getFullYear()}&month=${now.getMonth() + 1}`;
    }

    // --- Modal Logic ---
    function showTaskDetails(task) {
        const statusConfig = {
            'todo': { label: 'À faire', class: 'bg-indigo-100 text-indigo-700 border-indigo-200' },
            'in_progress': { label: 'En cours', class: 'bg-amber-100 text-amber-700 border-amber-200' },
            'done': { label: 'Terminé', class: 'bg-emerald-100 text-emerald-700 border-emerald-200' }
        };

        const priorityConfig = {
            'low': { label: 'Faible', class: 'bg-slate-100 text-slate-600' },
            'medium': { label: 'Moyenne', class: 'bg-blue-100 text-blue-600' },
            'high': { label: 'Haute', class: 'bg-rose-100 text-rose-600' }
        };

        // Format date safely
        let formattedDate = 'Non définie';
        if (task.due_date) {
            if (task.due_date.seconds) {
                formattedDate = new Date(task.due_date.seconds * 1000).toLocaleDateString('fr-FR');
            } else {
                formattedDate = new Date(task.due_date).toLocaleDateString('fr-FR');
            }
        }

        const modalContent = `
            <div class="px-6 py-4 border-b border-slate-100 dark:border-slate-700 flex justify-between items-start bg-slate-50/50 dark:bg-slate-800/50">
                <h3 class="text-lg font-bold text-slate-900 dark:text-white leading-tight pr-4">${task.title}</h3>
                <button onclick="hideTaskModal()" class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-200 transition-colors">
                    <i class="fa-solid fa-times text-lg"></i>
                </button>
            </div>
            
            <div class="p-6 space-y-5">
                <div class="flex gap-3">
                    <span class="px-2.5 py-1 rounded-lg text-xs font-bold border ${statusConfig[task.status].class}">
                        ${statusConfig[task.status].label}
                    </span>
                    <span class="px-2.5 py-1 rounded-lg text-xs font-bold ${priorityConfig[task.priority || 'low'].class}">
                        ${priorityConfig[task.priority || 'low'].label}
                    </span>
                </div>

                <div class="bg-slate-50 dark:bg-slate-900/50 p-4 rounded-xl border border-slate-100 dark:border-slate-700">
                    <p class="text-sm text-slate-600 dark:text-slate-300 whitespace-pre-wrap leading-relaxed">
                        ${task.description || '<span class="italic text-slate-400">Aucune description fournie.</span>'}
                    </p>
                </div>

                <div class="grid grid-cols-2 gap-4 text-sm">
                    <div>
                        <p class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-1">Assigné à</p>
                        <div class="flex items-center gap-2">
                            <div class="w-6 h-6 rounded-full bg-brand-100 text-brand-600 flex items-center justify-center text-xs font-bold">
                                ${(task.assignee || 'U').charAt(0).toUpperCase()}
                            </div>
                            <span class="font-medium text-slate-700 dark:text-slate-200">${task.assignee || 'Non assigné'}</span>
                        </div>
                    </div>
                    <div>
                        <p class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-1">Date limite</p>
                        <div class="flex items-center gap-2 text-slate-700 dark:text-slate-200">
                            <i class="fa-regular fa-calendar text-slate-400"></i>
                            <span class="font-medium">${formattedDate}</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="px-6 py-4 bg-slate-50 dark:bg-slate-700/30 border-t border-slate-100 dark:border-slate-700 flex gap-3">
                <button onclick="hideTaskModal()" class="flex-1 px-4 py-2.5 bg-white dark:bg-slate-700 border border-slate-200 dark:border-slate-600 text-slate-700 dark:text-slate-200 font-semibold rounded-xl hover:bg-slate-50 dark:hover:bg-slate-600 transition-colors">
                    Fermer
                </button>
                <button onclick="goToBoardAndEdit()" class="flex-1 px-4 py-2.5 bg-brand-600 text-white font-semibold rounded-xl hover:bg-brand-700 shadow-lg shadow-brand-500/20 transition-all">
                    Modifier
                </button>
            </div>
        `;
        
        document.getElementById('taskModalContent').innerHTML = modalContent;
        document.getElementById('taskModal').classList.remove('hidden');
    }

    function hideTaskModal() {
        document.getElementById('taskModal').classList.add('hidden');
    }

    function goToBoardAndEdit() {
        // Redirect to board (since edit logic is complex to replicate entirely here without duplicating code)
        window.location.href = `{{ url_for('projects.project_board', project_id=project.id) }}`;
    }

    // Close modal on outside click
    document.getElementById('taskModal').addEventListener('click', function(e) {
        if (e.target === this) hideTaskModal();
    });

    // Helper: Open New Task Modal (Requires functions from board.html script if shared, 
    // otherwise redirects to board for creation)
    function openNewTaskModalWithDate(dateStr) {
        // Since the main Create Task modal code is in board.html, 
        // the simplest "Pro" way is to redirect to board, or if you included the modal code 
        // in base_fr.html, call it here. 
        // For now, let's redirect to the board.
        window.location.href = `{{ url_for('projects.project_board', project_id=project.id) }}`;
    }
    
    // Wire up the main "New Task" button to redirect too if logic isn't shared
    const createBtn = document.getElementById('createBtn');
    if(createBtn) {
        createBtn.onclick = function() {
             window.location.href = `{{ url_for('projects.project_board', project_id=project.id) }}`;
        }
    }
</script>
{% endblock %}