{% extends "base_fr.html" %}

{% block title %}{{ project.name }} - Calendrier{% endblock %}
{% block header %}{{ project.name }} - Calendrier{% endblock %}

{% block content %}
<!-- En-tête du Calendrier -->
<div class="bg-white dark:bg-slate-800/50 rounded-xl p-6 mb-6 shadow-lg border border-slate-200 dark:border-slate-700">
    <div class="flex items-center justify-between">
        <div class="flex items-center space-x-4">
            <button id="prevMonth" class="p-3 rounded-xl bg-gradient-to-r from-slate-100 to-slate-200 dark:from-slate-700 dark:to-slate-600 text-slate-600 dark:text-slate-300 hover:from-slate-200 hover:to-slate-300 dark:hover:from-slate-600 dark:hover:to-slate-500 transition-all duration-300 shadow-md hover:shadow-lg transform hover:scale-105">
                <i class="fa-solid fa-chevron-left"></i>
            </button>
            <h2 id="currentMonth" class="text-3xl font-bold bg-gradient-to-r from-indigo-600 to-purple-600 bg-clip-text text-transparent">{{ current_month }} {{ current_year }}</h2>
            <button id="nextMonth" class="p-3 rounded-xl bg-gradient-to-r from-slate-100 to-slate-200 dark:from-slate-700 dark:to-slate-600 text-slate-600 dark:text-slate-300 hover:from-slate-200 hover:to-slate-300 dark:hover:from-slate-600 dark:hover:to-slate-500 transition-all duration-300 shadow-md hover:shadow-lg transform hover:scale-105">
                <i class="fa-solid fa-chevron-right"></i>
            </button>
        </div>
        <div class="flex items-center space-x-4">
            <button id="todayBtn" class="px-6 py-3 bg-gradient-to-r from-indigo-600 to-indigo-700 hover:from-indigo-700 hover:to-indigo-800 text-white rounded-xl transition-all duration-300 shadow-lg hover:shadow-xl transform hover:scale-105 font-medium">
                Aujourd'hui
            </button>
            <!-- Légende -->
            <div class="flex items-center space-x-4 text-sm">
                <div class="flex items-center space-x-2">
                    <div class="w-3 h-3 bg-blue-500 rounded-full shadow-sm"></div>
                    <span class="text-slate-600 dark:text-slate-400">À faire</span>
                </div>
                <div class="flex items-center space-x-2">
                    <div class="w-3 h-3 bg-orange-500 rounded-full shadow-sm"></div>
                    <span class="text-slate-600 dark:text-slate-400">En cours</span>
                </div>
                <div class="flex items-center space-x-2">
                    <div class="w-3 h-3 bg-green-500 rounded-full shadow-sm"></div>
                    <span class="text-slate-600 dark:text-slate-400">Terminé</span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Grille du Calendrier -->
<div class="bg-white dark:bg-slate-800/50 rounded-xl shadow-lg border border-slate-200 dark:border-slate-700 overflow-hidden">
    <!-- En-têtes des jours -->
    <div class="grid grid-cols-7 bg-slate-50 dark:bg-slate-700/50">
        <div class="p-4 text-center font-semibold text-slate-700 dark:text-slate-300 border-r border-slate-200 dark:border-slate-600">Lun</div>
        <div class="p-4 text-center font-semibold text-slate-700 dark:text-slate-300 border-r border-slate-200 dark:border-slate-600">Mar</div>
        <div class="p-4 text-center font-semibold text-slate-700 dark:text-slate-300 border-r border-slate-200 dark:border-slate-600">Mer</div>
        <div class="p-4 text-center font-semibold text-slate-700 dark:text-slate-300 border-r border-slate-200 dark:border-slate-600">Jeu</div>
        <div class="p-4 text-center font-semibold text-slate-700 dark:text-slate-300 border-r border-slate-200 dark:border-slate-600">Ven</div>
        <div class="p-4 text-center font-semibold text-slate-700 dark:text-slate-300 border-r border-slate-200 dark:border-slate-600">Sam</div>
        <div class="p-4 text-center font-semibold text-slate-700 dark:text-slate-300">Dim</div>
    </div>
    
    <!-- Grille des jours -->
    <div class="grid grid-cols-7">
        {% for day in calendar_days %}
        <div class="calendar-day p-2 {% if day.is_today %}today{% endif %} {% if not day.is_current_month %}other-month{% endif %}">
            <!-- Numéro du jour -->
            <div class="font-semibold text-slate-900 dark:text-white mb-2">{{ day.day }}</div>
            
            <!-- Tâches (maximum 3 visibles) -->
            {% for task in day.tasks %}
            <div class="task-strip task-{{ task.status }}" onclick="showTaskDetails({{ task | tojson | safe }})">
                {{ task.title }}
            </div>
            {% endfor %}
            
            <!-- Indicateur pour les tâches supplémentaires -->
            {% if day.extra_tasks > 0 %}
            <div class="text-xs text-slate-500 dark:text-slate-400 cursor-pointer hover:text-slate-700 dark:hover:text-slate-300">
                + {{ day.extra_tasks }} autres...
            </div>
            {% endif %}
        </div>
        {% endfor %}
    </div>
</div>

<!-- Modal de Détails de Tâche -->
<div id="taskModal" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center">
    <div class="bg-white dark:bg-slate-800 rounded-xl p-6 w-full max-w-md mx-4 shadow-2xl border border-slate-200 dark:border-slate-700">
        <div id="taskModalContent"></div>
    </div>
</div>

<style>
    .calendar-day {
        min-height: 120px;
        border-right: 1px solid;
        border-bottom: 1px solid;
        @apply border-slate-200 dark:border-slate-600 transition-all duration-300;
    }
    
    .calendar-day:hover {
        @apply bg-gradient-to-br from-slate-50 to-slate-100 dark:from-slate-700/30 dark:to-slate-600/30 transform scale-[1.02] shadow-lg;
    }
    
    .task-strip {
        @apply text-xs px-3 py-2 rounded-lg mb-2 cursor-pointer truncate transition-all duration-300 shadow-sm;
    }
    
    .task-strip:hover {
        @apply scale-105 shadow-lg transform -translate-y-0.5;
    }
    
    .task-todo {
        @apply bg-gradient-to-r from-blue-100 to-blue-200 dark:from-blue-900/40 dark:to-blue-800/40 text-blue-800 dark:text-blue-300 border-l-4 border-blue-500;
    }
    
    .task-in_progress {
        @apply bg-gradient-to-r from-orange-100 to-orange-200 dark:from-orange-900/40 dark:to-orange-800/40 text-orange-800 dark:text-orange-300 border-l-4 border-orange-500;
    }
    
    .task-done {
        @apply bg-gradient-to-r from-green-100 to-green-200 dark:from-green-900/40 dark:to-green-800/40 text-green-800 dark:text-green-300 border-l-4 border-green-500;
    }
    
    .today {
        @apply bg-gradient-to-br from-indigo-50 to-indigo-100 dark:from-indigo-900/30 dark:to-indigo-800/30 border-2 border-indigo-500 shadow-lg;
    }
    
    .other-month {
        @apply text-slate-400 dark:text-slate-600 bg-slate-50/50 dark:bg-slate-800/20;
    }
    
    .calendar-transition {
        @apply transition-all duration-500 ease-in-out;
    }
</style>
{% endblock %}

{% block scripts %}
<script>
    // Activer la navigation projet
    document.addEventListener('DOMContentLoaded', function() {
        switchToProjectNav('{{ project.id }}', '{{ project.name }}');
        
        // Marquer l'onglet actuel comme actif
        document.getElementById('calendarTab').classList.add('bg-indigo-100', 'dark:bg-indigo-900/30', 'text-indigo-600', 'dark:text-indigo-400');
        
        // Navigation du calendrier
        let currentYear = {{ current_year }};
        let currentMonth = {{ current_month_index }}; // Index du mois
        
        const monthNames = [
            'Janvier', 'Février', 'Mars', 'Avril', 'Mai', 'Juin',
            'Juillet', 'Août', 'Septembre', 'Octobre', 'Novembre', 'Décembre'
        ];
        
        // Bouton mois précédent
        document.getElementById('prevMonth').addEventListener('click', function() {
            currentMonth--;
            if (currentMonth < 1) {
                currentMonth = 12;
                currentYear--;
            }
            navigateToMonth(currentYear, currentMonth);
        });
        
        // Bouton mois suivant
        document.getElementById('nextMonth').addEventListener('click', function() {
            currentMonth++;
            if (currentMonth > 12) {
                currentMonth = 1;
                currentYear++;
            }
            navigateToMonth(currentYear, currentMonth);
        });
        
        // Bouton aujourd'hui
        document.getElementById('todayBtn').addEventListener('click', function() {
            const today = new Date();
            currentYear = today.getFullYear();
            currentMonth = today.getMonth() + 1;
            navigateToMonth(currentYear, currentMonth);
        });
        
        function navigateToMonth(year, month) {
            // Animation de transition
            const calendarGrid = document.querySelector('.grid.grid-cols-7:last-child');
            const monthHeader = document.getElementById('currentMonth');
            
            calendarGrid.style.opacity = '0.5';
            calendarGrid.style.transform = 'scale(0.95)';
            
            // Requête AJAX
            fetch(`/projects/{{ project.id }}/calendar/data/${year}/${month}`)
                .then(response => response.json())
                .then(data => {
                    // Mettre à jour le titre
                    monthHeader.textContent = `${data.current_month} ${data.current_year}`;
                    
                    // Mettre à jour la grille
                    updateCalendarGrid(data.calendar_days);
                    
                    // Animation de retour
                    setTimeout(() => {
                        calendarGrid.style.opacity = '1';
                        calendarGrid.style.transform = 'scale(1)';
                    }, 100);
                    
                    // Mettre à jour les variables
                    currentYear = year;
                    currentMonth = month;
                })
                .catch(error => console.error('Erreur:', error));
        }
        
        function updateCalendarGrid(calendarDays) {
            const grid = document.querySelector('.grid.grid-cols-7:last-child');
            grid.innerHTML = '';
            
            calendarDays.forEach(day => {
                const dayDiv = document.createElement('div');
                dayDiv.className = `calendar-day p-2 ${day.is_today ? 'today' : ''} ${!day.is_current_month ? 'other-month' : ''}`;
                
                let tasksHtml = '';
                day.tasks.forEach(task => {
                    tasksHtml += `<div class="task-strip task-${task.status}" onclick="showTaskDetails(${JSON.stringify(task).replace(/"/g, '&quot;')})">${task.title}</div>`;
                });
                
                if (day.extra_tasks > 0) {
                    tasksHtml += `<div class="text-xs text-slate-500 dark:text-slate-400 cursor-pointer hover:text-slate-700 dark:hover:text-slate-300">+ ${day.extra_tasks} autres...</div>`;
                }
                
                dayDiv.innerHTML = `
                    <div class="font-semibold text-slate-900 dark:text-white mb-2">${day.day}</div>
                    ${tasksHtml}
                `;
                
                grid.appendChild(dayDiv);
            });
        }
    });
    
    // Afficher les détails d'une tâche
    function showTaskDetails(task) {
        const statusText = {
            'todo': 'À faire',
            'in_progress': 'En cours',
            'done': 'Terminé'
        };
        
        const priorityText = {
            'low': 'Faible',
            'medium': 'Moyenne',
            'high': 'Élevée'
        };
        
        let dueDate = '';
        if (task.due_date) {
            if (task.due_date.seconds) {
                dueDate = new Date(task.due_date.seconds * 1000).toLocaleDateString('fr-FR');
            } else {
                dueDate = new Date(task.due_date).toLocaleDateString('fr-FR');
            }
        }
        
        document.getElementById('taskModalContent').innerHTML = `
            <div class="flex justify-between items-start mb-4">
                <h3 class="text-xl font-semibold text-slate-900 dark:text-white">${task.title}</h3>
                <button onclick="hideTaskModal()" class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-300">
                    <i class="fa-solid fa-times"></i>
                </button>
            </div>
            
            <div class="space-y-4">
                <div>
                    <p class="text-slate-600 dark:text-slate-400">${task.description || 'Aucune description'}</p>
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <p class="text-sm font-medium text-slate-700 dark:text-slate-300">Statut</p>
                        <span class="inline-block px-2 py-1 rounded text-xs task-${task.status}">
                            ${statusText[task.status]}
                        </span>
                    </div>
                    <div>
                        <p class="text-sm font-medium text-slate-700 dark:text-slate-300">Priorité</p>
                        <span class="priority-badge priority-${task.priority || 'low'}">
                            ${priorityText[task.priority || 'low']}
                        </span>
                    </div>
                </div>
                
                ${dueDate ? `
                <div>
                    <p class="text-sm font-medium text-slate-700 dark:text-slate-300">Échéance</p>
                    <p class="text-slate-600 dark:text-slate-400">${dueDate}</p>
                </div>
                ` : ''}
                
                ${task.assignee ? `
                <div>
                    <p class="text-sm font-medium text-slate-700 dark:text-slate-300">Assigné à</p>
                    <p class="text-slate-600 dark:text-slate-400">${task.assignee}</p>
                </div>
                ` : ''}
                
                <div class="flex space-x-3 pt-4">
                    <button onclick="editTask('${task.id}')" class="flex-1 bg-indigo-600 hover:bg-indigo-700 text-white py-2 rounded-lg transition-colors">
                        Modifier
                    </button>
                    <button onclick="hideTaskModal()" class="flex-1 bg-slate-500 dark:bg-slate-600 hover:bg-slate-600 dark:hover:bg-slate-700 text-white py-2 rounded-lg transition-colors">
                        Fermer
                    </button>
                </div>
            </div>
        `;
        
        document.getElementById('taskModal').classList.remove('hidden');
    }
    
    function hideTaskModal() {
        document.getElementById('taskModal').classList.add('hidden');
    }
    
    function editTask(taskId) {
        hideTaskModal();
        // Rediriger vers le tableau Kanban avec la tâche sélectionnée
        window.location.href = `{{ url_for('projects.project_board', project_id=project.id) }}`;
    }
    
    // Fermer le modal en cliquant à l'extérieur
    document.getElementById('taskModal').addEventListener('click', function(e) {
        if (e.target === this) hideTaskModal();
    });
</script>
{% endblock %}