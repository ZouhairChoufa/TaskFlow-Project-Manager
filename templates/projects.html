{% extends "base.html" %}

{% block title %}Projects - TaskFlow{% endblock %}
{% block header %}Projects{% endblock %}

{% block content %}
<!-- Projects Grid -->
<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
    {% for project in projects %}
    {% set current_user_id = 'anonymous' %}
    {% set is_member = current_user_id in project.get('members', []) %}
    <div class="bg-white dark:bg-slate-800/50 rounded-xl p-6 hover:scale-105 transition-all duration-300 group shadow-lg border border-slate-200 dark:border-slate-700">
        <div class="flex items-start justify-between mb-4">
            <div class="flex-1">
                <h3 class="text-lg font-semibold text-slate-900 dark:text-white mb-2">{{ project.name }}</h3>
                <p class="text-slate-600 dark:text-slate-400 text-sm">{{ project.description }}</p>
            </div>
            <div class="opacity-0 group-hover:opacity-100 transition-opacity">
                <button onclick="deleteProject('{{ project.id }}')" 
                        class="text-rose-500 dark:text-rose-400 hover:text-rose-600 dark:hover:text-rose-300 p-1">
                    <i class="fa-solid fa-trash text-sm"></i>
                </button>
            </div>
        </div>
        
        {% if project.deadline %}
        <div class="flex items-center text-slate-600 dark:text-slate-400 text-sm mb-4">
            <i class="fa-solid fa-calendar mr-2"></i>
            Due: {{ project.deadline.strftime('%Y-%m-%d') }}
        </div>
        {% endif %}
        
        <div class="flex items-center justify-between">
            <div class="flex items-center space-x-2">
                <span class="text-xs bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-300 px-2 py-1 rounded-full">
                    {{ project.created_at.strftime('%m/%d/%Y') if project.created_at else 'Recently' }}
                </span>
                {% if not is_member %}
                <span class="text-xs bg-amber-100 dark:bg-amber-900 text-amber-700 dark:text-amber-300 px-2 py-1 rounded-full">
                    <i class="fa-solid fa-lock mr-1"></i>Private
                </span>
                {% endif %}
            </div>
            {% if is_member %}
            <a href="{{ url_for('projects.project_board', project_id=project.id) }}" 
               class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg text-sm transition-all duration-300 hover:scale-105">
                <i class="fa-solid fa-arrow-right mr-1"></i>Open Board
            </a>
            {% else %}
            <button onclick="openJoinModal('{{ project.id }}', '{{ project.name }}')" 
                    class="bg-amber-600 hover:bg-amber-700 text-white px-4 py-2 rounded-lg text-sm transition-all duration-300 hover:scale-105">
                <i class="fa-solid fa-unlock mr-1"></i>Join Project
            </button>
            {% endif %}
        </div>
    </div>
    {% endfor %}
    
    {% if not projects %}
    <div class="col-span-full text-center py-12">
        <div class="bg-white dark:bg-slate-800/30 rounded-xl p-8 shadow-lg border border-slate-200 dark:border-slate-700">
            <i class="fa-solid fa-folder-open text-4xl text-slate-400 dark:text-slate-500 mb-4"></i>
            <h3 class="text-xl font-semibold text-slate-700 dark:text-slate-300 mb-2">No Projects Yet</h3>
            <p class="text-slate-600 dark:text-slate-400 mb-6">Create your first project to get started with TaskFlow</p>
            <button onclick="document.getElementById('createBtn').click()" 
                    class="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-3 rounded-lg transition-all duration-300 hover:scale-105">
                <i class="fa-solid fa-plus mr-2"></i>Create Your First Project
            </button>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script>
    // Create Project Modal
    document.getElementById('createBtn').addEventListener('click', function() {
        showModal(`
            <h3 class="text-xl font-semibold text-slate-900 dark:text-white mb-4">Create New Project</h3>
            <form id="projectForm">
                <div class="space-y-4">
                    <div>
                        <label class="block text-slate-700 dark:text-slate-300 text-sm font-medium mb-2">Project Name</label>
                        <input type="text" name="name" required 
                               class="w-full px-3 py-2 bg-white dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-lg text-slate-900 dark:text-white focus:outline-none focus:border-indigo-500">
                    </div>
                    <div>
                        <label class="block text-slate-700 dark:text-slate-300 text-sm font-medium mb-2">Description</label>
                        <textarea name="description" rows="3"
                                  class="w-full px-3 py-2 bg-white dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-lg text-slate-900 dark:text-white focus:outline-none focus:border-indigo-500"></textarea>
                    </div>
                    <div>
                        <label class="block text-slate-700 dark:text-slate-300 text-sm font-medium mb-2">Access Code</label>
                        <input type="text" name="access_code" required placeholder="e.g. TEAM2024"
                               class="w-full px-3 py-2 bg-white dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-lg text-slate-900 dark:text-white focus:outline-none focus:border-indigo-500">
                        <p class="text-slate-500 dark:text-slate-400 text-xs mt-1">Share this code with your team to let them join</p>
                    </div>
                    <div>
                        <label class="block text-slate-700 dark:text-slate-300 text-sm font-medium mb-2">Deadline (Optional)</label>
                        <input type="date" name="deadline"
                               class="w-full px-3 py-2 bg-white dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-lg text-slate-900 dark:text-white focus:outline-none focus:border-indigo-500">
                    </div>
                    <div class="flex space-x-3 pt-4">
                        <button type="submit" class="flex-1 bg-indigo-600 hover:bg-indigo-700 text-white py-2 rounded-lg transition-colors">
                            Create Project
                        </button>
                        <button type="button" onclick="hideModal()" class="flex-1 bg-slate-500 dark:bg-slate-600 hover:bg-slate-600 dark:hover:bg-slate-700 text-white py-2 rounded-lg transition-colors">
                            Cancel
                        </button>
                    </div>
                </div>
            </form>
        `);

        document.getElementById('projectForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData);
            
            const result = await apiCall('/projects/create', {
                method: 'POST',
                body: JSON.stringify(data)
            });
            
            if (result.success) {
                hideModal();
                location.reload();
            }
        });
    });

    // Project Join Modal
    function openJoinModal(projectId, projectName) {
        showModal(`
            <h3 class="text-xl font-semibold text-slate-900 dark:text-white mb-4">Join Project</h3>
            <p class="text-slate-600 dark:text-slate-400 mb-4">"${projectName}" is private. Please enter the access code to join.</p>
            <form id="projectJoinForm">
                <div class="space-y-4">
                    <div>
                        <label class="block text-slate-700 dark:text-slate-300 text-sm font-medium mb-2">Access Code</label>
                        <input type="password" name="access_code" required placeholder="Enter access code"
                               class="w-full px-3 py-2 bg-white dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-lg text-slate-900 dark:text-white focus:outline-none focus:border-indigo-500">
                        <div id="joinError" class="text-rose-600 text-sm mt-1 hidden"></div>
                    </div>
                    <div class="flex space-x-3 pt-4">
                        <button type="submit" class="flex-1 bg-indigo-600 hover:bg-indigo-700 text-white py-2 rounded-lg transition-colors">
                            <i class="fa-solid fa-unlock mr-2"></i>Unlock & Join
                        </button>
                        <button type="button" onclick="hideModal()" class="flex-1 bg-slate-500 dark:bg-slate-600 hover:bg-slate-600 dark:hover:bg-slate-700 text-white py-2 rounded-lg transition-colors">
                            Cancel
                        </button>
                    </div>
                </div>
            </form>
        `);

        document.getElementById('projectJoinForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData);
            const errorDiv = document.getElementById('joinError');
            
            try {
                const result = await apiCall(`/projects/${projectId}/join`, {
                    method: 'POST',
                    body: JSON.stringify(data)
                });
                
                if (result.success) {
                    hideModal();
                    window.location.href = `/projects/${projectId}/board`;
                } else {
                    errorDiv.textContent = result.message || 'Failed to join project';
                    errorDiv.classList.remove('hidden');
                }
            } catch (error) {
                errorDiv.textContent = 'Error joining project';
                errorDiv.classList.remove('hidden');
            }
        });
    }

    // Delete Project
    async function deleteProject(projectId) {
        if (confirm('Are you sure you want to delete this project? This will also delete all associated tasks.')) {
            const result = await apiCall(`/projects/${projectId}/delete`, {
                method: 'DELETE'
            });
            
            if (result.success) {
                location.reload();
            }
        }
    }
</script>
{% endblock %}