{% extends "base_fr.html" %}

{% block title %}Projects - TaskFlow{% endblock %}
{% block header %}Projects{% endblock %}

{% block content %}
<!-- Projects Grid -->
<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
    {% for project in projects %}
    {% set current_user_id = session.get('user', {}).get('uid') %}
    {% set is_owner = project.get('created_by') == current_user_id %}
    {% set is_member = current_user_id in project.get('members', []) %}
    <div class="bg-white dark:bg-slate-800/50 rounded-xl p-6 hover:scale-105 transition-all duration-300 group shadow-lg border border-slate-200 dark:border-slate-700">
        <div class="flex items-start justify-between mb-4">
            <div class="flex-1">
                <h3 class="text-lg font-semibold text-slate-900 dark:text-white mb-2">{{ project.name }}</h3>
                <p class="text-slate-600 dark:text-slate-400 text-sm">{{ project.description }}</p>
            </div>
            {% if is_owner %}
            <div class="opacity-0 group-hover:opacity-100 transition-opacity">
                <button onclick="deleteProject('{{ project.id }}')" 
                        class="text-rose-500 dark:text-rose-400 hover:text-rose-600 dark:hover:text-rose-300 p-1">
                    <i class="fa-solid fa-trash text-sm"></i>
                </button>
            </div>
            {% endif %}
        </div>
        
        {% if project.deadline %}
        <div class="flex items-center text-slate-600 dark:text-slate-400 text-sm mb-4">
            <i class="fa-solid fa-calendar mr-2"></i>
            Due: {{ project.deadline.strftime('%Y-%m-%d') }}
        </div>
        {% endif %}
        
        <div class="flex items-center justify-between">
            <div class="flex items-center space-x-2">
                <span class="text-xs bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-300 px-2 py-1 rounded-full">
                    {{ project.created_at.strftime('%m/%d/%Y') if project.created_at else 'Recently' }}
                </span>
                {% if is_owner %}
                <span class="text-xs bg-emerald-100 dark:bg-emerald-900 text-emerald-700 dark:text-emerald-300 px-2 py-1 rounded-full">
                    <i class="fa-solid fa-crown mr-1"></i>Propriétaire
                </span>
                {% elif is_member %}
                <span class="text-xs bg-teal-100 dark:bg-teal-900 text-teal-700 dark:text-teal-300 px-2 py-1 rounded-full">
                    <i class="fa-solid fa-check-circle mr-1"></i>Membre
                </span>
                {% else %}
                <span class="text-xs bg-amber-100 dark:bg-amber-900 text-amber-700 dark:text-amber-300 px-2 py-1 rounded-full">
                    <i class="fa-solid fa-lock mr-1"></i>Privé
                </span>
                {% endif %}
            </div>
            {% if is_owner %}
            <a href="{{ url_for('projects.view_project', project_id=project.id) }}" 
               class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg text-sm transition-all duration-300 hover:scale-105">
                <i class="fa-solid fa-cog mr-1"></i>Gérer
            </a>
            {% elif is_member %}
            <a href="{{ url_for('projects.view_project', project_id=project.id) }}" 
               class="bg-slate-600 hover:bg-slate-700 text-white px-4 py-2 rounded-lg text-sm transition-all duration-300 hover:scale-105">
                <i class="fa-solid fa-arrow-right mr-1"></i>Ouvrir
            </a>
            {% else %}
            <button onclick="openJoinModal('{{ project.id }}', '{{ project.name }}')" 
                    class="bg-amber-600 hover:bg-amber-700 text-white px-4 py-2 rounded-lg text-sm transition-all duration-300 hover:scale-105">
                <i class="fa-solid fa-unlock mr-1"></i>Rejoindre
            </button>
            {% endif %}
        </div>
    </div>
    {% endfor %}
    
    {% if not projects %}
    <div class="col-span-full text-center py-12">
        <div class="bg-white dark:bg-slate-800/30 rounded-xl p-8 shadow-lg border border-slate-200 dark:border-slate-700">
            <i class="fa-solid fa-folder-open text-4xl text-slate-400 dark:text-slate-500 mb-4"></i>
            <h3 class="text-xl font-semibold text-slate-700 dark:text-slate-300 mb-2">No Projects Yet</h3>
            <p class="text-slate-600 dark:text-slate-400 mb-6">Create your first project to get started with TaskFlow</p>
            <button onclick="document.getElementById('createBtn').click()" 
                    class="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-3 rounded-lg transition-all duration-300 hover:scale-105">
                <i class="fa-solid fa-plus mr-2"></i>Create Your First Project
            </button>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script>
    // Create Project Modal
    document.getElementById('createBtn').addEventListener('click', function() {
        showModal(`
            <h3 class="text-xl font-semibold text-slate-900 dark:text-white mb-4">Créer un Nouveau Projet</h3>
            <form id="projectForm">
                <div class="space-y-4">
                    <div>
                        <label class="block text-slate-700 dark:text-slate-300 text-sm font-medium mb-2">Nom du Projet</label>
                        <input type="text" name="name" required 
                               class="w-full px-3 py-2 bg-white dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-lg text-slate-900 dark:text-white focus:outline-none focus:border-indigo-500">
                    </div>
                    <div>
                        <label class="block text-slate-700 dark:text-slate-300 text-sm font-medium mb-2">Description</label>
                        <textarea name="description" rows="3"
                                  class="w-full px-3 py-2 bg-white dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-lg text-slate-900 dark:text-white focus:outline-none focus:border-indigo-500"></textarea>
                    </div>
                    <div>
                        <label class="block text-slate-700 dark:text-slate-300 text-sm font-medium mb-2">Code d'Accès (Mot de passe)</label>
                        <div class="flex space-x-2">
                            <input type="text" name="access_code" id="accessCodeInput" required placeholder="Ex: Team2025"
                                   class="flex-1 px-3 py-2 bg-white dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-lg text-slate-900 dark:text-white focus:outline-none focus:border-indigo-500">
                            <button type="button" onclick="generateRandomCode()" class="px-3 py-2 bg-slate-100 dark:bg-slate-600 text-slate-600 dark:text-slate-300 rounded-lg hover:bg-slate-200 dark:hover:bg-slate-500 transition-colors">
                                <i class="fa-solid fa-dice"></i>
                            </button>
                        </div>
                        <p class="text-slate-500 dark:text-slate-400 text-xs mt-1">Partagez ce code avec votre équipe pour qu'elle puisse rejoindre le projet</p>
                    </div>
                    <div>
                        <label class="block text-slate-700 dark:text-slate-300 text-sm font-medium mb-2">Échéance (Optionnel)</label>
                        <input type="date" name="deadline"
                               class="w-full px-3 py-2 bg-white dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-lg text-slate-900 dark:text-white focus:outline-none focus:border-indigo-500">
                    </div>
                    <div class="flex space-x-3 pt-4">
                        <button type="submit" class="flex-1 bg-indigo-600 hover:bg-indigo-700 text-white py-2 rounded-lg transition-colors">
                            Créer le Projet
                        </button>
                        <button type="button" onclick="hideModal()" class="flex-1 bg-slate-500 dark:bg-slate-600 hover:bg-slate-600 dark:hover:bg-slate-700 text-white py-2 rounded-lg transition-colors">
                            Annuler
                        </button>
                    </div>
                </div>
            </form>
        `);

        document.getElementById('projectForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData);
            
            try {
                const result = await apiCall('/projects/create', {
                    method: 'POST',
                    body: JSON.stringify(data)
                });
                
                if (result.success) {
                    hideModal();
                    showToast('Projet créé avec succès !', 'success');
                    setTimeout(() => location.reload(), 1000);
                } else {
                    showToast(result.error || 'Erreur lors de la création', 'error');
                }
            } catch (error) {
                showToast('Erreur lors de la création du projet', 'error');
            }
        });
    });
    
    // Generate random access code
    function generateRandomCode() {
        const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
        let result = '';
        for (let i = 0; i < 8; i++) {
            result += chars.charAt(Math.floor(Math.random() * chars.length));
        }
        document.getElementById('accessCodeInput').value = result;
    }

    // Project Join Modal - ID-based password verification
    function openJoinModal(projectId, projectName) {
        showModal(`
            <h3 class="text-xl font-semibold text-slate-900 dark:text-white mb-4">Rejoindre le Projet</h3>
            <p class="text-slate-600 dark:text-slate-400 mb-4">"${projectName.replace(/"/g, '&quot;').replace(/'/g, '&#39;')}" est privé. Entrez le code d'accès pour le rejoindre.</p>
            <form id="projectJoinForm">
                <div class="space-y-4">
                    <div>
                        <label class="block text-slate-700 dark:text-slate-300 text-sm font-medium mb-2">Code d'Accès</label>
                        <input type="password" name="access_code" required placeholder="Entrez le code d'accès"
                               class="w-full px-3 py-2 bg-white dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-lg text-slate-900 dark:text-white focus:outline-none focus:border-indigo-500">
                        <div id="joinError" class="text-rose-600 text-sm mt-1 hidden"></div>
                    </div>
                    <div class="flex space-x-3 pt-4">
                        <button type="submit" class="flex-1 bg-indigo-600 hover:bg-indigo-700 text-white py-2 rounded-lg transition-colors">
                            <i class="fa-solid fa-unlock mr-2"></i>Rejoindre
                        </button>
                        <button type="button" onclick="hideModal()" class="flex-1 bg-slate-500 dark:bg-slate-600 hover:bg-slate-600 dark:hover:bg-slate-700 text-white py-2 rounded-lg transition-colors">
                            Annuler
                        </button>
                    </div>
                </div>
            </form>
        `);

        document.getElementById('projectJoinForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData);
            const errorDiv = document.getElementById('joinError');
            
            try {
                const result = await apiCall(`/projects/join_project/${projectId}`, {
                    method: 'POST',
                    body: JSON.stringify(data)
                });
                
                if (result.success) {
                    hideModal();
                    if (result.already_member) {
                        showToast(result.message, 'success');
                    } else {
                        showToast(result.message || 'Projet rejoint avec succès', 'success');
                        setTimeout(() => location.reload(), 1000);
                    }
                } else {
                    errorDiv.textContent = result.message || 'Code incorrect';
                    errorDiv.classList.remove('hidden');
                }
            } catch (error) {
                errorDiv.textContent = 'Erreur lors de la connexion au projet';
                errorDiv.classList.remove('hidden');
            }
        });
    }

    // Delete Project with custom confirmation
    async function deleteProject(projectId) {
        const confirmed = await confirmDelete(null, 
            'Supprimer ce projet ?', 
            'Toutes les tâches et données du projet seront définitivement supprimées.');
        
        if (confirmed) {
            try {
                const result = await apiCall(`/projects/${projectId}/delete`, {
                    method: 'DELETE'
                });
                
                if (result.success) {
                    showToast('Projet supprimé avec succès', 'success');
                    setTimeout(() => location.reload(), 1000);
                } else {
                    showToast('Erreur lors de la suppression', 'error');
                }
            } catch (error) {
                showToast('Erreur lors de la suppression', 'error');
            }
        }
    }
</script>
{% endblock %}