{% extends "base_fr.html" %}

{% block title %}{{ project.name }} - Vue d'ensemble{% endblock %}
{% block header %}{{ project.name }} - Vue d'ensemble{% endblock %}

{% block content %}
<!-- Statistiques du Projet -->
<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
    <!-- Total des Tâches -->
    <div class="bg-white dark:bg-slate-800/50 rounded-xl p-6 shadow-lg border border-slate-200 dark:border-slate-700">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-slate-600 dark:text-slate-400 text-sm font-medium">Total des Tâches</p>
                <p class="text-2xl font-bold text-slate-900 dark:text-white">{{ stats.total_tasks }}</p>
            </div>
            <div class="p-3 bg-indigo-100 dark:bg-indigo-900/30 rounded-lg">
                <i class="fa-solid fa-tasks text-indigo-600 dark:text-indigo-400 text-xl"></i>
            </div>
        </div>
    </div>

    <!-- Tâches Terminées -->
    <div class="bg-white dark:bg-slate-800/50 rounded-xl p-6 shadow-lg border border-slate-200 dark:border-slate-700">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-slate-600 dark:text-slate-400 text-sm font-medium">Tâches Terminées</p>
                <p class="text-2xl font-bold text-emerald-600 dark:text-emerald-400">{{ stats.completed_tasks }}</p>
            </div>
            <div class="p-3 bg-emerald-100 dark:bg-emerald-900/30 rounded-lg">
                <i class="fa-solid fa-check-circle text-emerald-600 dark:text-emerald-400 text-xl"></i>
            </div>
        </div>
    </div>

    <!-- Pourcentage de Completion -->
    <div class="bg-white dark:bg-slate-800/50 rounded-xl p-6 shadow-lg border border-slate-200 dark:border-slate-700">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-slate-600 dark:text-slate-400 text-sm font-medium">Progression</p>
                <p class="text-2xl font-bold text-blue-600 dark:text-blue-400">{{ stats.completion_percentage }}%</p>
            </div>
            <div class="p-3 bg-blue-100 dark:bg-blue-900/30 rounded-lg">
                <i class="fa-solid fa-chart-pie text-blue-600 dark:text-blue-400 text-xl"></i>
            </div>
        </div>
        <!-- Barre de progression -->
        <div class="mt-4 bg-slate-200 dark:bg-slate-700 rounded-full h-2">
            <div class="bg-blue-600 dark:bg-blue-400 h-2 rounded-full transition-all duration-300" style="width: {{ stats.completion_percentage }}%"></div>
        </div>
    </div>

    <!-- Tâches en Attente -->
    <div class="bg-white dark:bg-slate-800/50 rounded-xl p-6 shadow-lg border border-slate-200 dark:border-slate-700">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-slate-600 dark:text-slate-400 text-sm font-medium">En Attente</p>
                <p class="text-2xl font-bold text-amber-600 dark:text-amber-400">{{ stats.pending_tasks }}</p>
            </div>
            <div class="p-3 bg-amber-100 dark:bg-amber-900/30 rounded-lg">
                <i class="fa-solid fa-clock text-amber-600 dark:text-amber-400 text-xl"></i>
            </div>
        </div>
    </div>
</div>

<div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
    <!-- Informations du Projet -->
    <div class="lg:col-span-2 space-y-8">
        <!-- Description du Projet -->
        <div class="bg-white dark:bg-slate-800/50 rounded-xl p-6 shadow-lg border border-slate-200 dark:border-slate-700">
            <h3 class="text-lg font-semibold text-slate-900 dark:text-white mb-4">
                <i class="fa-solid fa-info-circle text-indigo-500 mr-2"></i>Description du Projet
            </h3>
            <p class="text-slate-600 dark:text-slate-400 leading-relaxed">
                {{ project.description or "Aucune description disponible pour ce projet." }}
            </p>
            {% if project.deadline %}
            <div class="mt-4 p-3 bg-slate-50 dark:bg-slate-700/50 rounded-lg">
                <p class="text-sm text-slate-600 dark:text-slate-400">
                    <i class="fa-solid fa-calendar-alt text-rose-500 mr-2"></i>
                    <strong>Échéance :</strong> {{ project.deadline.strftime('%d %B %Y') }}
                </p>
            </div>
            {% endif %}
        </div>

        <!-- Activité Récente -->
        <div class="bg-white dark:bg-slate-800/50 rounded-xl p-6 shadow-lg border border-slate-200 dark:border-slate-700">
            <h3 class="text-lg font-semibold text-slate-900 dark:text-white mb-4">
                <i class="fa-solid fa-history text-indigo-500 mr-2"></i>Activité Récente
            </h3>
            {% if recent_tasks %}
            <div class="space-y-3">
                {% for task in recent_tasks %}
                <div class="flex items-center justify-between p-3 bg-slate-50 dark:bg-slate-700/50 rounded-lg">
                    <div class="flex items-center space-x-3">
                        <div class="w-3 h-3 rounded-full 
                            {% if task.status == 'done' %}bg-green-500
                            {% elif task.status == 'in_progress' %}bg-orange-500
                            {% else %}bg-blue-500{% endif %}">
                        </div>
                        <div>
                            <p class="font-medium text-slate-900 dark:text-white">{{ task.title }}</p>
                            <p class="text-sm text-slate-500 dark:text-slate-400">
                                {% if task.status == 'done' %}Terminée
                                {% elif task.status == 'in_progress' %}En cours
                                {% else %}À faire{% endif %}
                                {% if task.assignee %} • Assignée à {{ task.assignee }}{% endif %}
                            </p>
                        </div>
                    </div>
                    <span class="priority-badge priority-{{ task.priority or 'low' }}">
                        {{ (task.priority or 'low').title() }}
                    </span>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="text-center py-8">
                <i class="fa-solid fa-inbox text-slate-400 text-3xl mb-3"></i>
                <p class="text-slate-500 dark:text-slate-400">Aucune activité récente</p>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Sidebar -->
    <div class="space-y-6">
        <!-- L'Équipe -->
        <div class="bg-white dark:bg-slate-800/50 rounded-xl p-6 shadow-lg border border-slate-200 dark:border-slate-700">
            <h3 class="text-lg font-semibold text-slate-900 dark:text-white mb-4">
                <i class="fa-solid fa-users text-indigo-500 mr-2"></i>L'Équipe
            </h3>
            <div class="flex items-center justify-between">
                <div class="flex -space-x-2">
                    {% for member in members_data %}
                    <div class="w-10 h-10 bg-indigo-100 dark:bg-indigo-900/30 rounded-full flex items-center justify-center border-2 border-white dark:border-slate-800 shadow-lg cursor-pointer hover:scale-110 transition-transform"
                         onclick="showMemberInfo(this)"
                         data-member-id="{{ member.uid }}"
                         data-username="{{ member.username }}"
                         data-email="{{ member.email }}"
                         data-phone="{{ member.phone if member.phone else 'Non renseigné' }}">
                        <span class="text-indigo-600 dark:text-indigo-400 text-xs font-semibold">{{ member.username | initials }}</span>
                    </div>
                    {% endfor %}
                </div>
                <span class="text-sm text-slate-600 dark:text-slate-400">{{ members_data|length }} membre{{ 's' if members_data|length > 1 else '' }}</span>
            </div>
            <button id="inviteMemberBtn" class="w-full mt-4 px-4 py-2 bg-indigo-100 dark:bg-indigo-900/30 text-indigo-600 dark:text-indigo-400 rounded-lg hover:bg-indigo-200 dark:hover:bg-indigo-900/50 transition-colors">
                <i class="fa-solid fa-user-plus mr-2"></i>Inviter des Membres
            </button>
        </div>

        <!-- Actions Rapides -->
        <div class="bg-white dark:bg-slate-800/50 rounded-xl p-6 shadow-lg border border-slate-200 dark:border-slate-700">
            <h3 class="text-lg font-semibold text-slate-900 dark:text-white mb-4">
                <i class="fa-solid fa-bolt text-indigo-500 mr-2"></i>Actions Rapides
            </h3>
            <div class="space-y-3">
                <a href="{{ url_for('projects.project_board', project_id=project.id) }}" class="block w-full px-4 py-3 bg-blue-100 dark:bg-blue-900/30 text-blue-600 dark:text-blue-400 rounded-lg hover:bg-blue-200 dark:hover:bg-blue-900/50 transition-colors text-center">
                    <i class="fa-solid fa-columns mr-2"></i>Voir le Tableau Kanban
                </a>
                <a href="{{ url_for('projects.project_calendar', project_id=project.id) }}" class="block w-full px-4 py-3 bg-green-100 dark:bg-green-900/30 text-green-600 dark:text-green-400 rounded-lg hover:bg-green-200 dark:hover:bg-green-900/50 transition-colors text-center">
                    <i class="fa-solid fa-calendar mr-2"></i>Voir le Calendrier
                </a>
                <button id="createTaskBtn" class="w-full px-4 py-3 bg-indigo-100 dark:bg-indigo-900/30 text-indigo-600 dark:text-indigo-400 rounded-lg hover:bg-indigo-200 dark:hover:bg-indigo-900/50 transition-colors">
                    <i class="fa-solid fa-plus mr-2"></i>Nouvelle Tâche
                </button>
            </div>
        </div>

        {% if project.created_by == session.get('user', {}).get('uid') %}
        <!-- Code d'Accès (Owner Only) -->
        <div class="bg-white dark:bg-slate-800/50 rounded-xl p-6 shadow-lg border border-slate-200 dark:border-slate-700">
            <h3 class="text-lg font-semibold text-slate-900 dark:text-white mb-4">
                <i class="fa-solid fa-key text-indigo-500 mr-2"></i>Code d'Accès
            </h3>
            <div class="bg-slate-50 dark:bg-slate-700/50 rounded-lg p-3">
                <p class="font-mono text-lg text-center text-slate-900 dark:text-white">{{ project.access_code }}</p>
            </div>
            <p class="text-xs text-slate-500 dark:text-slate-400 mt-2 text-center">
                Partagez ce code pour inviter des membres
            </p>
        </div>
        {% else %}
        <!-- Member Badge -->
        <div class="bg-white dark:bg-slate-800/50 rounded-xl p-6 shadow-lg border border-slate-200 dark:border-slate-700">
            <div class="text-center">
                <div class="w-16 h-16 bg-teal-100 dark:bg-teal-900/30 rounded-full flex items-center justify-center mx-auto mb-3">
                    <i class="fa-solid fa-check-circle text-teal-600 dark:text-teal-400 text-2xl"></i>
                </div>
                <h3 class="text-lg font-semibold text-slate-900 dark:text-white mb-2">Membre du Projet</h3>
                <p class="text-sm text-slate-600 dark:text-slate-400">Vous avez accès à ce projet</p>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<style>
    .priority-high {
        @apply bg-rose-600 text-white text-xs px-2 py-1 rounded-full;
    }
    .priority-medium {
        @apply bg-amber-600 text-white text-xs px-2 py-1 rounded-full;
    }
    .priority-low {
        @apply bg-slate-600 text-white text-xs px-2 py-1 rounded-full;
    }
</style>
{% endblock %}

{% block scripts %}
<script>
    // Activer la navigation projet
    document.addEventListener('DOMContentLoaded', function() {
        switchToProjectNav('{{ project.id }}', '{{ project.name|replace("'", "\\'")|replace('"', '\\"') }}');
        
        // Marquer l'onglet actuel comme actif
        document.getElementById('overviewTab').classList.add('bg-indigo-100', 'dark:bg-indigo-900/30', 'text-indigo-600', 'dark:text-indigo-400');
    });

    // Inviter un membre
    document.getElementById('inviteMemberBtn').addEventListener('click', function() {
        showModal(`
            <h3 class="text-xl font-semibold text-slate-900 dark:text-white mb-4">Inviter un Membre</h3>
            <form id="inviteForm">
                <div class="space-y-4">
                    <div>
                        <label class="block text-slate-700 dark:text-slate-300 text-sm font-medium mb-2">Email du Membre</label>
                        <input type="email" name="email" required placeholder="exemple@email.com"
                               class="w-full px-3 py-2 bg-white dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-lg text-slate-900 dark:text-white focus:outline-none focus:border-indigo-500">
                    </div>
                    <div class="bg-blue-50 dark:bg-blue-900/20 p-3 rounded-lg">
                        <p class="text-sm text-blue-700 dark:text-blue-300">
                            <i class="fa-solid fa-info-circle mr-2"></i>
                            L'utilisateur pourra rejoindre le projet automatiquement lors de sa connexion.
                        </p>
                    </div>
                    <div class="flex space-x-3 pt-4">
                        <button type="submit" class="flex-1 bg-indigo-600 hover:bg-indigo-700 text-white py-2 rounded-lg transition-colors">
                            Envoyer l'Invitation
                        </button>
                        <button type="button" onclick="hideModal()" class="flex-1 bg-slate-500 dark:bg-slate-600 hover:bg-slate-600 dark:hover:bg-slate-700 text-white py-2 rounded-lg transition-colors">
                            Annuler
                        </button>
                    </div>
                </div>
            </form>
        `);

        document.getElementById('inviteForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData);
            
            const result = await apiCall('/projects/{{ project.id }}/invite_member', {
                method: 'POST',
                body: JSON.stringify(data)
            });
            
            if (result.success) {
                hideModal();
                showToast(result.message, 'success');
            } else {
                showToast(result.error, result.category || 'error');
            }
        });
    });
    
    // Créer une nouvelle tâche
    document.getElementById('createTaskBtn').addEventListener('click', function() {
        showModal(`
            <h3 class="text-xl font-semibold text-slate-900 dark:text-white mb-4">Nouvelle Tâche</h3>
            <form id="taskForm">
                <div class="space-y-4">
                    <div>
                        <label class="block text-slate-700 dark:text-slate-300 text-sm font-medium mb-2">Titre de la Tâche</label>
                        <input type="text" name="title" required 
                               class="w-full px-3 py-2 bg-white dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-lg text-slate-900 dark:text-white focus:outline-none focus:border-indigo-500">
                    </div>
                    <div>
                        <label class="block text-slate-700 dark:text-slate-300 text-sm font-medium mb-2">Description</label>
                        <textarea name="description" rows="3"
                                  class="w-full px-3 py-2 bg-white dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-lg text-slate-900 dark:text-white focus:outline-none focus:border-indigo-500"></textarea>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-slate-700 dark:text-slate-300 text-sm font-medium mb-2">Statut</label>
                            <select name="status" class="w-full px-3 py-2 bg-white dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-lg text-slate-900 dark:text-white focus:outline-none focus:border-indigo-500">
                                <option value="todo">À faire</option>
                                <option value="in_progress">En cours</option>
                                <option value="done">Terminé</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-slate-700 dark:text-slate-300 text-sm font-medium mb-2">Priorité</label>
                            <select name="priority" class="w-full px-3 py-2 bg-white dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-lg text-slate-900 dark:text-white focus:outline-none focus:border-indigo-500">
                                <option value="low">Faible</option>
                                <option value="medium">Moyenne</option>
                                <option value="high">Élevée</option>
                            </select>
                        </div>
                    </div>
                    <div>
                        <label class="block text-slate-700 dark:text-slate-300 text-sm font-medium mb-2">Date d'Échéance</label>
                        <input type="date" name="due_date"
                               class="w-full px-3 py-2 bg-white dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-lg text-slate-900 dark:text-white focus:outline-none focus:border-indigo-500">
                    </div>
                    <div>
                        <label class="block text-slate-700 dark:text-slate-300 text-sm font-medium mb-2">Assigné à</label>
                        <input type="text" name="assignee" placeholder="Nom de la personne"
                               class="w-full px-3 py-2 bg-white dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-lg text-slate-900 dark:text-white focus:outline-none focus:border-indigo-500">
                    </div>
                    <div class="flex space-x-3 pt-4">
                        <button type="submit" class="flex-1 bg-indigo-600 hover:bg-indigo-700 text-white py-2 rounded-lg transition-colors">
                            Créer la Tâche
                        </button>
                        <button type="button" onclick="hideModal()" class="flex-1 bg-slate-500 dark:bg-slate-600 hover:bg-slate-600 dark:hover:bg-slate-700 text-white py-2 rounded-lg transition-colors">
                            Annuler
                        </button>
                    </div>
                </div>
            </form>
        `);

        document.getElementById('taskForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData);
            data.project_id = '{{ project.id }}';
            
            const result = await apiCall('/tasks/create', {
                method: 'POST',
                body: JSON.stringify(data)
            });
            
            if (result.success) {
                hideModal();
                showToast('Tâche créée avec succès !', 'success');
                setTimeout(() => location.reload(), 1500);
            }
        });
    });
</script>
{% endblock %}